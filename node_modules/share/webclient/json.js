((function(){var a,b,c,d,e,f,g,h=!0,i=Array.prototype.slice,j=window.sharejs;typeof h!="undefined"&&h!==null?f=j.types.text:f=require("./text"),d={},d.name="json",d.create=function(){return null},d.invertComponent=function(a){var b={p:a.p};return a.si!==void 0&&(b.sd=a.si),a.sd!==void 0&&(b.si=a.sd),a.oi!==void 0&&(b.od=a.oi),a.od!==void 0&&(b.oi=a.od),a.li!==void 0&&(b.ld=a.li),a.ld!==void 0&&(b.li=a.ld),a.na!==void 0&&(b.na=-a.na),a.lm!==void 0&&(b.lm=a.p[a.p.length-1],b.p=a.p.slice(0,a.p.length-1).concat([a.lm])),b},d.invert=function(a){var b,c,e,f=a.slice().reverse(),g=[];for(c=0,e=f.length;c<e;c++)b=f[c],g.push(d.invertComponent(b));return g},d.checkValidOp=function(){},c=function(a){return Object.prototype.toString.call(a)==="[object Array]"},d.checkList=function(a){if(!c(a))throw new Error("Referenced element not a list")},d.checkObj=function(a){if(a.constructor!==Object)throw new Error("Referenced element not an object (it was "+JSON.stringify(a)+")")},d.apply=function(a,b){var c,e,f,g,h,i,j,k,l,m,n,o,p;d.checkValidOp(b),b=d.clone(b),e={data:d.clone(a)};try{for(h=0,n=b.length;h<n;h++){c=b[h],k=null,l=null,g=e,i="data",p=c.p;for(m=0,o=p.length;m<o;m++){j=p[m],k=g,l=i,g=g[i],i=j;if(k==null)throw new Error("Path invalid")}if(c.na!==void 0){if(typeof g[i]!="number")throw new Error("Referenced element not a number");g[i]+=c.na}else if(c.si!==void 0){if(typeof g!="string")throw new Error("Referenced element not a string (it was "+JSON.stringify(g)+")");k[l]=g.slice(0,i)+c.si+g.slice(i)}else if(c.sd!==void 0){if(typeof g!="string")throw new Error("Referenced element not a string");if(g.slice(i,i+c.sd.length)!==c.sd)throw new Error("Deleted string does not match");k[l]=g.slice(0,i)+g.slice(i+c.sd.length)}else if(c.li!==void 0&&c.ld!==void 0)d.checkList(g),g[i]=c.li;else if(c.li!==void 0)d.checkList(g),g.splice(i,0,c.li);else if(c.ld!==void 0)d.checkList(g),g.splice(i,1);else if(c.lm!==void 0)d.checkList(g),c.lm!==i&&(f=g[i],g.splice(i,1),g.splice(c.lm,0,f));else if(c.oi!==void 0)d.checkObj(g),g[i]=c.oi;else if(c.od!==void 0)d.checkObj(g),delete g[i];else throw new Error("invalid / missing instruction in op")}}catch(q){throw q}return e.data},d.pathMatches=function(a,b,c){var d,e,f;if(a.length!==b.length)return!1;for(d=0,f=a.length;d<f;d++){e=a[d];if(e!==b[d]&&(!c||d!==a.length-1))return!1}return!0},d.append=function(a,b){var c;return b=d.clone(b),a.length!==0&&d.pathMatches(b.p,(c=a[a.length-1]).p)?c.na!==void 0&&b.na!==void 0?a[a.length-1]={p:c.p,na:c.na+b.na}:c.li!==void 0&&b.li===void 0&&b.ld===c.li?c.ld!==void 0?delete c.li:a.pop():c.od!==void 0&&c.oi===void 0&&b.oi!==void 0&&b.od===void 0?c.oi=b.oi:b.lm!==void 0&&b.p[b.p.length-1]===b.lm?null:a.push(b):a.push(b)},d.compose=function(a,b){var c,e,f,g;d.checkValidOp(a),d.checkValidOp(b),e=d.clone(a);for(f=0,g=b.length;f<g;f++)c=b[f],d.append(e,c);return e},d.normalize=function(a){var b,e,f,g,h=[];c(a)||(a=[a]);for(e=0,f=a.length;e<f;e++)b=a[e],(g=b.p)==null&&(b.p=[]),d.append(h,b);return h},d.clone=function(a){return JSON.parse(JSON.stringify(a))},d.commonPath=function(a,b){var c;a=a.slice(),b=b.slice(),a.unshift("data"),b.unshift("data"),a=a.slice(0,a.length-1),b=b.slice(0,b.length-1);if(b.length===0)return-1;c=0;while(a[c]===b[c]&&c<a.length){c++;if(c===b.length)return c-1}},d.transformComponent=function(a,b,c,e){var g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y;b=d.clone(b),b.na!==void 0&&b.p.push(0),c.na!==void 0&&c.p.push(0),g=d.commonPath(b.p,c.p),h=d.commonPath(c.p,b.p),k=b.p.length,o=c.p.length,b.na!==void 0&&b.p.pop(),c.na!==void 0&&c.p.pop();if(c.na)return h!=null&&o>=k&&c.p[h]===b.p[h]&&(b.ld!==void 0?(n=d.clone(c),n.p=n.p.slice(k),b.ld=d.apply(d.clone(b.ld),[n])):b.od!==void 0&&(n=d.clone(c),n.p=n.p.slice(k),b.od=d.apply(d.clone(b.od),[n]))),d.append(a,b),a;h!=null&&o>k&&b.p[h]===c.p[h]&&(b.ld!==void 0?(n=d.clone(c),n.p=n.p.slice(k),b.ld=d.apply(d.clone(b.ld),[n])):b.od!==void 0&&(n=d.clone(c),n.p=n.p.slice(k),b.od=d.apply(d.clone(b.od),[n])));if(g!=null){i=k===o;if(c.na===void 0)if(c.si!==void 0||c.sd!==void 0){if(b.si!==void 0||b.sd!==void 0){if(!i)throw new Error("must be a string?");j=function(a){var b={p:a.p[a.p.length-1]};return a.si?b.i=a.si:b.d=a.sd,b},u=j(b),v=j(c),s=[],f._tc(s,u,v,e);for(x=0,y=s.length;x<y;x++)t=s[x],m={p:b.p.slice(0,g)},m.p.push(t.p),t.i!=null&&(m.si=t.i),t.d!=null&&(m.sd=t.d),d.append(a,m);return a}}else if(c.li!==void 0&&c.ld!==void 0){if(c.p[g]===b.p[g]){if(!i)return a;if(b.ld!==void 0)if(b.li!==void 0&&e==="left")b.ld=d.clone(c.li);else return a}}else if(c.li!==void 0)b.li!==void 0&&b.ld===void 0&&i&&b.p[g]===c.p[g]?e==="right"&&b.p[g]++:c.p[g]<=b.p[g]&&b.p[g]++,b.lm!==void 0&&i&&c.p[g]<=b.lm&&b.lm++;else if(c.ld!==void 0){if(b.lm!==void 0&&i){if(c.p[g]===b.p[g])return a;r=c.p[g],l=b.p[g],w=b.lm,(r<w||r===w&&l<w)&&b.lm--}if(c.p[g]<b.p[g])b.p[g]--;else if(c.p[g]===b.p[g]){if(o<k)return a;if(b.ld!==void 0)if(b.li!==void 0)delete b.ld;else return a}}else if(c.lm!==void 0)if(b.lm!==void 0&&k===o){l=b.p[g],w=b.lm,p=c.p[g],q=c.lm;if(p!==q)if(l===p)if(e==="left")b.p[g]=q,l===w&&(b.lm=q);else return a;else l>p&&b.p[g]--,l>q?b.p[g]++:l===q&&p>q&&(b.p[g]++,l===w&&b.lm++),w>p?b.lm--:w===p&&w>l&&b.lm--,w>q?b.lm++:w===q&&(q>p&&w>l||q<p&&w<l?e==="right"&&b.lm++:w>l?b.lm++:w===p&&b.lm--)}else b.li!==void 0&&b.ld===void 0&&i?(l=c.p[g],w=c.lm,r=b.p[g],r>l&&b.p[g]--,r>w&&b.p[g]++):(l=c.p[g],w=c.lm,r=b.p[g],r===l?b.p[g]=w:(r>l&&b.p[g]--,r>w?b.p[g]++:r===w&&l>w&&b.p[g]++));else if(c.oi!==void 0&&c.od!==void 0){if(b.p[g]===c.p[g]){if(b.oi===void 0||!i)return a;if(e==="right")return a;b.od=c.oi}}else if(c.oi!==void 0){if(b.oi!==void 0&&b.p[g]===c.p[g])if(e==="left")d.append(a,{p:b.p,od:c.oi});else return a}else if(c.od!==void 0&&b.p[g]===c.p[g]){if(!i)return a;if(b.oi!==void 0)delete b.od;else return a}}return d.append(a,b),a},typeof h!="undefined"&&h!==null?(j.types||(j.types={}),j._bt(d,d.transformComponent,d.checkValidOp,d.append),j.types.json=d):(module.exports=d,require("./helpers").bootstrapTransform(d,d.transformComponent,d.checkValidOp,d.append)),typeof h=="undefined"&&(d=require("./json")),b=function(a){return a.length===1&&a[0].constructor===Array?a[0]:a},a=function(){function a(a,b){this.doc=a,this.path=b}return a.prototype.at=function(){var a=1<=arguments.length?i.call(arguments,0):[];return this.doc.at(this.path.concat(b(a)))},a.prototype.get=function(){return this.doc.getAt(this.path)},a.prototype.set=function(a,b){return this.doc.setAt(this.path,a,b)},a.prototype.insert=function(a,b,c){return this.doc.insertAt(this.path,a,b,c)},a.prototype.del=function(a,b,c){return this.doc.deleteTextAt(this.path,b,a,c)},a.prototype.remove=function(a){return this.doc.removeAt(this.path,a)},a.prototype.push=function(a,b){return this.insert(this.get().length,a,b)},a.prototype.move=function(a,b,c){return this.doc.moveAt(this.path,a,b,c)},a.prototype.add=function(a,b){return this.doc.addAt(this.path,a,b)},a.prototype.on=function(a,b){return this.doc.addListener(this.path,a,b)},a.prototype.removeListener=function(a){return this.doc.removeListener(a)},a.prototype.getLength=function(){return this.get().length},a.prototype.getText=function(){return this.get()},a}(),g=function(a,b){var c,d,e,f={data:a},g="data",h=f;for(d=0,e=b.length;d<e;d++){c=b[d],h=h[g],g=c;if(typeof h=="undefined")throw new Error("bad path")}return{elem:h,key:g}},e=function(a,b){var c,d,e;if(a.length!==b.length)return!1;for(d=0,e=a.length;d<e;d++){c=a[d];if(c!==b[d])return!1}return!0},d.api={provides:{json:!0},at:function(){var c=1<=arguments.length?i.call(arguments,0):[];return new a(this,b(c))},get:function(){return this.snapshot},set:function(a,b){return this.setAt([],a,b)},getAt:function(a){var b=g(this.snapshot,a),c=b.elem,d=b.key;return c[d]},setAt:function(a,b,c){var d=g(this.snapshot,a),e=d.elem,f=d.key,h={p:a};if(e.constructor===Array)h.li=b,typeof e[f]!="undefined"&&(h.ld=e[f]);else if(typeof e=="object")h.oi=b,typeof e[f]!="undefined"&&(h.od=e[f]);else throw new Error("bad path");return this.submitOp([h],c)},removeAt:function(a,b){var c,d=g(this.snapshot,a),e=d.elem,f=d.key;if(typeof e[f]=="undefined")throw new Error("no element at that path");c={p:a};if(e.constructor===Array)c.ld=e[f];else if(typeof e=="object")c.od=e[f];else throw new Error("bad path");return this.submitOp([c],b)},insertAt:function(a,b,c,d){var e=g(this.snapshot,a),f=e.elem,h=e.key,i={p:a.concat(b)};return f[h].constructor===Array?i.li=c:typeof f[h]=="string"&&(i.si=c),this.submitOp([i],d)},moveAt:function(a,b,c,d){var e=[{p:a.concat(b),lm:c}];return this.submitOp(e,d)},addAt:function(a,b,c){var d=[{p:a,na:b}];return this.submitOp(d,c)},deleteTextAt:function(a,b,c,d){var e=g(this.snapshot,a),f=e.elem,h=e.key,i=[{p:a.concat(c),sd:f[h].slice(c,c+b)}];return this.submitOp(i,d)},addListener:function(a,b,c){var d={path:a,event:b,cb:c};return this._listeners.push(d),d},removeListener:function(a){var b=this._listeners.indexOf(a);return b<0?!1:(this._listeners.splice(b,1),!0)},_register:function(){return this._listeners=[],this.on("change",function(a){var b,c,d,e,f,g,h,i,j,k,l=[];for(h=0,i=a.length;h<i;h++){b=a[h];if(b.na!==void 0||b.si!==void 0||b.sd!==void 0)continue;f=[],k=this._listeners;for(d=0,j=k.length;d<j;d++){e=k[d],c={p:e.path,na:0},g=this.type.transformComponent([],c,b,"left");if(g.length===0)f.push(d);else if(g.length===1)e.path=g[0].p;else throw new Error("Bad assumption in json-api: xforming an 'si' op will always result in 0 or 1 components.")}f.sort(function(a,b){return b-a}),l.push(function(){var a,b,c=[];for(a=0,b=f.length;a<b;a++)d=f[a],c.push(this._listeners.splice(d,1));return c}.call(this))}return l}),this.on("remoteop",function(a){var b,c,d,f,g,h,i,j,k,l=[];for(j=0,k=a.length;j<k;j++)b=a[j],h=b.na===void 0?b.p.slice(0,b.p.length-1):b.p,l.push(function(){var a,j,k,l=this._listeners,m=[];for(a=0,j=l.length;a<j;a++){k=l[a],i=k.path,g=k.event,c=k.cb;if(e(i,h))switch(g){case"insert":b.li!==void 0&&b.ld===void 0?m.push(c(b.p[b.p.length-1],b.li)):b.oi!==void 0&&b.od===void 0?m.push(c(b.p[b.p.length-1],b.oi)):b.si!==void 0?m.push(c(b.p[b.p.length-1],b.si)):m.push(void 0);break;case"delete":b.li===void 0&&b.ld!==void 0?m.push(c(b.p[b.p.length-1],b.ld)):b.oi===void 0&&b.od!==void 0?m.push(c(b.p[b.p.length-1],b.od)):b.sd!==void 0?m.push(c(b.p[b.p.length-1],b.sd)):m.push(void 0);break;case"replace":b.li!==void 0&&b.ld!==void 0?m.push(c(b.p[b.p.length-1],b.ld,b.li)):b.oi!==void 0&&b.od!==void 0?m.push(c(b.p[b.p.length-1],b.od,b.oi)):m.push(void 0);break;case"move":b.lm!==void 0?m.push(c(b.p[b.p.length-1],b.lm)):m.push(void 0);break;case"add":b.na!==void 0?m.push(c(b.na)):m.push(void 0);break;default:m.push(void 0)}else if((f=this.type.commonPath(h,i))!=null)if(g==="child op"){if(h.length===i.length)throw new Error("paths match length and have commonality, but aren't equal?");d=b.p.slice(f+1),m.push(c(d,b))}else m.push(void 0);else m.push(void 0)}return m}.call(this));return l})}}})).call(this)